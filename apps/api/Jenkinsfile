pipeline {
    agent any
    
    environment {
        DOCKER_IMAGE = 'agentic-commerce-api'
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
                echo "Checked out branch: ${env.GIT_BRANCH}"
            }
        }
        
        stage('Install Dependencies') {
            steps {
                dir('apps/api') {
                    sh 'npm ci'
                }
            }
        }
        
        stage('Lint') {
            steps {
                dir('apps/api') {
                    sh 'npm run lint || true'
                }
            }
        }
        
        stage('Type Check') {
            steps {
                dir('apps/api') {
                    sh 'npm run type-check'
                }
            }
        }
        
        // stage('Test') {
        //     steps {
        //         dir('apps/api') {
        //             sh 'npm run test:run || true'
        //         }
        //     }
        // }
        
        stage('Build') {
            steps {
                dir('apps/api') {
                    sh 'npm run build'
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                dir('apps/api') {
                    sh 'docker build -t ${DOCKER_IMAGE}:latest .'
                }
            }
        }
        
        stage('Deploy Locally') {
            when {
                branch 'main'
            }
            steps {
                dir('apps/api') {
                    sh '''
                        # Stop and remove old container
                        docker stop agentic-api || true
                        docker rm agentic-api || true
                        
                        # Run new container
                        docker run -d \\
                            --name agentic-api \\
                            -p 3001:3001 \\
                            --env-file .env \\
                            --network agentic-network \\
                            --restart unless-stopped \\
                            ${DOCKER_IMAGE}:latest
                        
                        # Run database migrations
                        docker exec agentic-api npx prisma migrate deploy
                        
                        # Health check
                        sleep 10
                        curl -f http://localhost:3001/api/health || exit 1
                        
                        echo "Deployment successful!"
                    '''
                }
            }
        }
        
        stage('Cleanup') {
            steps {
                sh '''
                    # Remove old Docker images to save space
                    docker image prune -f
                '''
            }
        }
    }
    
    post {
        success {
            echo '✅ Pipeline completed successfully!'
            // Add Slack/Discord notification here
        }
        failure {
            echo '❌ Pipeline failed!'
            // Add Slack/Discord notification here
        }
        always {
            cleanWs()
        }
    }
}
